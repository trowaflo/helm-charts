suite: test cert-manager chart - ReferenceGrant
release:
  name: cert-manager-test
  namespace: cert-manager
templates:
  - templates/referencegrant.yaml
tests:
  # Test with no ReferenceGrants configured (default)
  - it: should not render ReferenceGrants when list is empty
    values:
      - values/default.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Test with ReferenceGrant enabled
  - it: should render ReferenceGrant when configured
    set:
      referenceGrants:
        - name: allow-kgateway-platform
          enabled: true
          from:
            - kind: Gateway
              namespace: kgateway-platform
          to:
            - kind: Secret
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ReferenceGrant
      - equal:
          path: metadata.name
          value: allow-kgateway-platform
      - equal:
          path: metadata.namespace
          value: cert-manager
      - equal:
          path: spec.from[0].group
          value: gateway.networking.k8s.io
      - equal:
          path: spec.from[0].kind
          value: Gateway
      - equal:
          path: spec.from[0].namespace
          value: kgateway-platform
      - equal:
          path: spec.to[0].group
          value: ""
      - equal:
          path: spec.to[0].kind
          value: Secret

  # Test with ReferenceGrant disabled
  - it: should not render ReferenceGrant when disabled
    set:
      referenceGrants:
        - name: allow-kgateway-platform
          enabled: false
          from:
            - kind: Gateway
              namespace: kgateway-platform
          to:
            - kind: Secret
    asserts:
      - hasDocuments:
          count: 0

  # Test with multiple ReferenceGrants
  - it: should render multiple ReferenceGrants when configured
    set:
      referenceGrants:
        - name: allow-kgateway-platform
          enabled: true
          from:
            - kind: Gateway
              namespace: kgateway-platform
          to:
            - kind: Secret
        - name: allow-another-namespace
          enabled: true
          from:
            - kind: HTTPRoute
              namespace: another-namespace
          to:
            - kind: Secret
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ReferenceGrant
        documentIndex: 0
      - equal:
          path: metadata.name
          value: allow-kgateway-platform
        documentIndex: 0
      - isKind:
          of: ReferenceGrant
        documentIndex: 1
      - equal:
          path: metadata.name
          value: allow-another-namespace
        documentIndex: 1
