suite: test cert-manager chart - enablement flags
values:
  - values/default.yaml
release:
  name: cert-manager-testing
  namespace: cert-manager
tests:
  # cert-manager enabled toggle
  - it: should render cert-manager resources when enabled
    templates:
      - ../charts/cert-manager/templates/deployment.yaml
      - ../charts/cert-manager/templates/service.yaml
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - containsDocument:
          apiVersion: v1
          kind: Service

  - it: should render no cert-manager resources when disabled
    templates:
      - ../charts/cert-manager/templates/deployment.yaml
      - ../charts/cert-manager/templates/service.yaml
    values:
      - values/disable-cert-manager.yaml
    asserts:
      - hasDocuments:
          count: 0

  # CRDs toggle
  - it: should render CRDs when crds.enabled is true
    templates:
      - ../charts/cert-manager/templates/crd-*.yaml
    asserts:
      - hasDocuments:
          count: 6

  - it: should render no CRDs when crds.enabled is false
    templates:
      - ../charts/cert-manager/templates/crd-*.yaml
    values:
      - values/disable-crds.yaml
    asserts:
      - hasDocuments:
          count: 0

  # webhook toggle
  - it: should render webhook resources when enabled
    templates:
      - ../charts/cert-manager-webhook-ovh/templates/deployment.yaml
      - ../charts/cert-manager-webhook-ovh/templates/service.yaml
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Service
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment

  - it: should render no webhook resources when disabled
    templates:
      - ../charts/cert-manager-webhook-ovh/templates/deployment.yaml
      - ../charts/cert-manager-webhook-ovh/templates/service.yaml
    values:
      - values/disable-webhook.yaml
    asserts:
      - hasDocuments:
          count: 0
