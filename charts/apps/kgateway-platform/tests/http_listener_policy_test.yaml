suite: test kgateway-platform chart - HTTP listener policies
release:
  name: kgateway-platform-test
  namespace: kgateway-test
capabilities:
  apiVersions:
    - gateway.networking.k8s.io/v1/Gateway
    - gateway.kgateway.dev/v1alpha1/GatewayParameters
    - gateway.kgateway.dev/v1alpha1/HTTPListenerPolicy
templates:
  - templates/http-listener-policy.yaml
tests:
  # Test with HTTP listener policy enabled and public gateway enabled
  - it: should render HTTPListenerPolicy when enabled with public gateway
    values:
      - values/default.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HTTPListenerPolicy
      - equal:
          path: metadata.name
          value: kgateway-platform-test-public-ws
      - equal:
          path: spec.targetRefs[0].name
          value: kgateway-platform-test-public

  # Test with HTTP listener policies disabled (empty map)
  - it: should not render HTTPListenerPolicy when disabled
    values:
      - values/disable-http-listener.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Test with public gateway disabled
  - it: should not render HTTPListenerPolicy when public gateway is disabled
    values:
      - values/disable-public.yaml
    asserts:
      - hasDocuments:
          count: 0
  
  # Test with multiple HTTP listener policies
  - it: should render multiple HTTPListenerPolicies when configured
    set:
      gateways.public.enabled: true
      gateways.public.address: "192.168.1.1"
      gateways.private.enabled: true
      gateways.private.address: "192.168.1.2"
      httpListenerPolicies.public-ws.enabled: true
      httpListenerPolicies.public-ws.targetGateway: "public"
      httpListenerPolicies.private-ws.enabled: true
      httpListenerPolicies.private-ws.targetGateway: "private"
    asserts:
      - hasDocuments:
          count: 2
