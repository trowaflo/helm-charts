{{- $namespace := include "kgateway-platform.namespace" . -}}
{{- range $policyKey, $policy := .Values.httpListenerPolicies }}
  {{- if $policy.enabled }}
    {{- $targetGateway := $policy.targetGateway -}}
    {{- if not $targetGateway }}
      {{- fail (printf "httpListenerPolicies.%s.targetGateway is required" $policyKey) }}
    {{- end }}
    {{- $gatewayCfg := index $.Values.gateways $targetGateway -}}
    {{- if not $gatewayCfg }}
      {{- fail (printf "httpListenerPolicies.%s.targetGateway '%s' does not exist in gateways map" $policyKey $targetGateway) }}
    {{- end }}
    {{- if $gatewayCfg.enabled }}
      {{- $gatewayName := include "kgateway-platform.gatewayName" (dict "root" $ "key" $targetGateway "config" $gatewayCfg) -}}
      {{- $policyName := include "kgateway-platform.httpListenerPolicyName" (dict "root" $ "key" $policyKey "config" $policy) -}}
      {{- $defaultUpgrades := list "websocket" -}}
      {{- $upgrades := default $defaultUpgrades $policy.enabledUpgrades }}
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
metadata:
  name: {{ $policyName }}
  namespace: {{ $namespace }}
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: {{ $gatewayName }}
  upgradeConfig:
    enabledUpgrades:
      {{- range $upgrade := $upgrades }}
      - {{ $upgrade | quote }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
