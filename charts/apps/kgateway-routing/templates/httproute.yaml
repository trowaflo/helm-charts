{{- $namespace := include "kgateway-routing.namespace" . -}}
{{- $keys := keys .Values.routes | sortAlpha -}}
{{- range $key := $keys }}
  {{- $cfg := index $.Values.routes $key }}
  {{- if $cfg.enabled }}
    {{- $name := include "kgateway-routing.routeName" (dict "root" $ "key" $key "config" $cfg) }}
    {{- $routeNamespace := default $namespace $cfg.namespace }}
    {{- $parentRefs := $cfg.parentRefs | default $.Values.defaultParentRefs }}
    {{- $hostnames := $cfg.hostnames }}
    {{- if and (not $hostnames) $.Values.dnsSuffix }}
      {{- $hostnames = list (printf "%s.%s" $key $.Values.dnsSuffix) }}
    {{- end }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $name }}
  namespace: {{ $routeNamespace }}
  {{- with $cfg.labels }}
  labels:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  annotations:
    kgateway-routing.helm.sh/route-name: {{ $name | quote }}
    kgateway-routing.helm.sh/route-namespace: {{ $routeNamespace | quote }}
    kgateway-routing.helm.sh/route-key: {{ $key | quote }}
    {{- if $parentRefs }}
    kgateway-routing.helm.sh/parent-refs: {{ $parentRefs | toJson | quote }}
    {{- end }}
    {{- if $.Values.defaultParentRefs }}
    kgateway-routing.helm.sh/default-parent-refs: {{ $.Values.defaultParentRefs | toJson | quote }}
    {{- end }}
    {{- if $hostnames }}
    kgateway-routing.helm.sh/hostnames: {{ $hostnames | toJson | quote }}
    {{- end }}
    {{- if $.Values.dnsSuffix }}
    kgateway-routing.helm.sh/dns-suffix: {{ $.Values.dnsSuffix | quote }}
    {{- end }}
    {{- with $cfg.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- if $parentRefs }}
  parentRefs:
    {{- range $parentRefs }}
    - group: {{ default "gateway.networking.k8s.io" .group }}
      kind: {{ default "Gateway" .kind }}
      name: {{ required (printf "routes.%s.parentRefs[].name is required (or set defaultParentRefs)" $key) .name }}
      {{- if .namespace }}
      namespace: {{ .namespace }}
      {{- end }}
      {{- if .sectionName }}
      sectionName: {{ .sectionName }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- if $hostnames }}
  hostnames:
    {{- toYaml $hostnames | nindent 4 }}
  {{- end }}
  {{- if or $cfg.inCluster $cfg.outCluster }}
  rules:
    
    {{- if $cfg.inCluster }}
      {{- range $backend := $cfg.inCluster }}
    - 
      {{- if $backend.matches }}
      matches:
        {{- toYaml $backend.matches | nindent 8 }}
      {{- else }}
      matches:
        - path:
            type: PathPrefix
            value: /
      {{- end }}
      backendRefs:
        - group: ""
          kind: Service
          name: {{ required (printf "routes.%s.inCluster[].name is required" $key) $backend.name }}
          port: {{ required (printf "routes.%s.inCluster[].port is required" $key) $backend.port }}
          {{- if $backend.namespace }}
          namespace: {{ $backend.namespace }}
          {{- end }}
          weight: {{ default 1 $backend.weight }}
      {{- if $backend.filters }}
      filters:
        {{- range $backend.filters }}
        - type: {{ required "filter type is required" .type }}
          {{- if .requestHeaderModifier }}
          requestHeaderModifier:
            {{- if .requestHeaderModifier.set }}
            set:
              {{- range .requestHeaderModifier.set }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .requestHeaderModifier.add }}
            add:
              {{- range .requestHeaderModifier.add }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .requestHeaderModifier.remove }}
            remove:
              {{- toYaml .requestHeaderModifier.remove | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if .responseHeaderModifier }}
          responseHeaderModifier:
            {{- if .responseHeaderModifier.set }}
            set:
              {{- range .responseHeaderModifier.set }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .responseHeaderModifier.add }}
            add:
              {{- range .responseHeaderModifier.add }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .responseHeaderModifier.remove }}
            remove:
              {{- toYaml .responseHeaderModifier.remove | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if .requestRedirect }}
          requestRedirect:
            {{- toYaml .requestRedirect | nindent 12 }}
          {{- end }}
          {{- if .requestMirror }}
          requestMirror:
            {{- toYaml .requestMirror | nindent 12 }}
          {{- end }}
          {{- if .urlRewrite }}
          urlRewrite:
            {{- toYaml .urlRewrite | nindent 12 }}
          {{- end }}
          {{- if .extensionRef }}
          extensionRef:
            {{- toYaml .extensionRef | nindent 12 }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
    
    {{- if $cfg.outCluster }}
      {{- range $idx, $backend := $cfg.outCluster }}
        {{- $backendName := printf "%s-%s-backend" $key $backend.name }}
    - 
      {{- if $backend.matches }}
      matches:
        {{- toYaml $backend.matches | nindent 8 }}
      {{- else }}
      matches:
        - path:
            type: PathPrefix
            value: /
      {{- end }}
      backendRefs:
        - group: gateway.kgateway.dev
          kind: Backend
          name: {{ $backendName }}
          weight: {{ default 1 $backend.weight }}
      {{- if $backend.filters }}
      filters:
        {{- range $backend.filters }}
        - type: {{ required "filter type is required" .type }}
          {{- if .requestHeaderModifier }}
          requestHeaderModifier:
            {{- if .requestHeaderModifier.set }}
            set:
              {{- range .requestHeaderModifier.set }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .requestHeaderModifier.add }}
            add:
              {{- range .requestHeaderModifier.add }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .requestHeaderModifier.remove }}
            remove:
              {{- toYaml .requestHeaderModifier.remove | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if .responseHeaderModifier }}
          responseHeaderModifier:
            {{- if .responseHeaderModifier.set }}
            set:
              {{- range .responseHeaderModifier.set }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .responseHeaderModifier.add }}
            add:
              {{- range .responseHeaderModifier.add }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .responseHeaderModifier.remove }}
            remove:
              {{- toYaml .responseHeaderModifier.remove | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if .requestRedirect }}
          requestRedirect:
            {{- toYaml .requestRedirect | nindent 12 }}
          {{- end }}
          {{- if .requestMirror }}
          requestMirror:
            {{- toYaml .requestMirror | nindent 12 }}
          {{- end }}
          {{- if .urlRewrite }}
          urlRewrite:
            {{- toYaml .urlRewrite | nindent 12 }}
          {{- end }}
          {{- if .extensionRef }}
          extensionRef:
            {{- toYaml .extensionRef | nindent 12 }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
  {{- else if $cfg.rules }}
    
  rules:
    {{- range $cfg.rules }}
    - {{- if .matches }}
      matches:
        {{- range .matches }}
        - {{- if .path }}
          path:
            type: {{ default "PathPrefix" .path.type }}
            value: {{ required "routes rule match path value is required when path is set" .path.value }}
          {{- end }}
          {{- if .headers }}
          headers:
            {{- toYaml .headers | nindent 12 }}
          {{- end }}
          {{- if .queryParams }}
          queryParams:
            {{- toYaml .queryParams | nindent 12 }}
          {{- end }}
          {{- if .method }}
          method: {{ .method }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if .backendRefs }}
      backendRefs:
        {{- range .backendRefs }}
        - group: {{ default "" .group | quote }}
          kind: {{ default "Service" .kind }}
          name: {{ required "routes rule backendRef name is required" .name }}
          {{- if .namespace }}
          namespace: {{ .namespace }}
          {{- end }}
          {{- if .port }}
          port: {{ .port }}
          {{- end }}
          weight: {{ default 1 .weight }}
        {{- end }}
      {{- end }}
      {{- if .filters }}
      filters:
        {{- range .filters }}
        - type: {{ required "filter type is required" .type }}
          {{- if .requestHeaderModifier }}
          requestHeaderModifier:
            {{- if .requestHeaderModifier.set }}
            set:
              {{- range .requestHeaderModifier.set }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .requestHeaderModifier.add }}
            add:
              {{- range .requestHeaderModifier.add }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .requestHeaderModifier.remove }}
            remove:
              {{- toYaml .requestHeaderModifier.remove | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if .responseHeaderModifier }}
          responseHeaderModifier:
            {{- if .responseHeaderModifier.set }}
            set:
              {{- range .responseHeaderModifier.set }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .responseHeaderModifier.add }}
            add:
              {{- range .responseHeaderModifier.add }}
              - name: {{ required "header name is required" .name }}
                value: {{ required "header value is required" .value | quote }}
              {{- end }}
            {{- end }}
            {{- if .responseHeaderModifier.remove }}
            remove:
              {{- toYaml .responseHeaderModifier.remove | nindent 14 }}
            {{- end }}
          {{- end }}
          {{- if .requestRedirect }}
          requestRedirect:
            {{- toYaml .requestRedirect | nindent 12 }}
          {{- end }}
          {{- if .requestMirror }}
          requestMirror:
            {{- toYaml .requestMirror | nindent 12 }}
          {{- end }}
          {{- if .urlRewrite }}
          urlRewrite:
            {{- toYaml .urlRewrite | nindent 12 }}
          {{- end }}
          {{- if .extensionRef }}
          extensionRef:
            {{- toYaml .extensionRef | nindent 12 }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- end }}
{{- end }}
