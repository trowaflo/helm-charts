{{- range $routeKey, $route := .Values.routes }}
{{- if $route.enabled }}
{{- $routeNamespace := default $.Release.Namespace $route.namespace }}
{{- $hasTLS := false }}
{{- $tlsBackends := list }}
{{- range $backend := $route.outCluster }}
  {{- if $backend.tls }}
    {{- $hasTLS = true }}
    {{- $tlsBackends = append $tlsBackends $backend }}
  {{- end }}
{{- end }}
{{- range $backend := $route.inCluster }}
  {{- if $backend.tls }}
    {{- $hasTLS = true }}
    {{- $tlsBackends = append $tlsBackends $backend }}
  {{- end }}
{{- end }}
{{- if $hasTLS }}
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: BackendConfigPolicy
metadata:
  name: {{ printf "%s-%s-policy" $.Release.Name $routeKey }}
  namespace: {{ $routeNamespace }}
  labels:
    {{- include "kgateway-routing.labels" $ | nindent 4 }}
spec:
  targetRefs:
    {{- range $backend := $tlsBackends }}
    - group: gateway.kgateway.dev
      kind: Backend
      name: {{ printf "%s-%s-backend" $routeKey $backend.name }}
    {{- end }}
  tls:
    {{- $firstBackend := index $tlsBackends 0 }}
    {{- if $firstBackend.sni }}
    sni: {{ $firstBackend.sni }}
    {{- else if $firstBackend.host }}
    sni: {{ $firstBackend.host }}
    {{- else }}
    sni: {{ $firstBackend.name }}
    {{- end }}
    {{- if $firstBackend.insecure }}
    insecureSkipVerify: true
    {{- end }}
{{- end }}
{{- end }}
{{- end }}
