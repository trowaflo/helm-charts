suite: test backendconfigpolicy
templates:
  - templates/backendconfigpolicy.yaml
tests:
  - it: should not render when route disabled
    set:
      routes:
        test:
          enabled: false
          backendPolicy:
            tls:
              sni: test.com
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when no backendPolicy defined
    set:
      routes:
        test:
          enabled: true
          hostnames: ["test.com"]
          parentRefs:
            - name: gateway
              namespace: kgateway-system
          outCluster:
            - name: test
              host: test.local
              port: 80
    asserts:
      - hasDocuments:
          count: 0

  - it: should render backendconfigpolicy with TLS settings
    set:
      routes:
        pmxx:
          enabled: true
          hostnames: ["pmxx.example.com"]
          parentRefs:
            - name: gateway
              namespace: kgateway-system
          outCluster:
            - name: pmxx
              host: proxmox1.example.com
              port: 8006
          backendPolicy:
            tls:
              sni: proxmox1.example.com
              insecureSkipVerify: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: BackendConfigPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-pmxx-policy
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: spec.targetRefs[0].group
          value: gateway.kgateway.dev
      - equal:
          path: spec.targetRefs[0].kind
          value: Backend
      - equal:
          path: spec.targetRefs[0].name
          value: pmxx-pmxx-backend
      - equal:
          path: spec.tls.sni
          value: proxmox1.example.com
      - equal:
          path: spec.tls.insecureSkipVerify
          value: true

  - it: should support SNI only
    set:
      routes:
        test:
          enabled: true
          hostnames: ["test.com"]
          parentRefs:
            - name: gateway
              namespace: kgateway-system
          outCluster:
            - name: test
              host: test.local
              port: 443
          backendPolicy:
            tls:
              sni: test.local
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.tls.sni
          value: test.local
      - isNull:
          path: spec.tls.insecureSkipVerify

  - it: should support insecureSkipVerify only
    set:
      routes:
        test:
          enabled: true
          hostnames: ["test.com"]
          parentRefs:
            - name: gateway
              namespace: kgateway-system
          outCluster:
            - name: test
              host: test.local
              port: 443
          backendPolicy:
            tls:
              insecureSkipVerify: false
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.tls.insecureSkipVerify
          value: false
      - isNull:
          path: spec.tls.sni

  - it: should link to multiple backends when multiple outCluster entries
    set:
      routes:
        multi:
          enabled: true
          hostnames: ["multi.example.com"]
          parentRefs:
            - name: gateway
              namespace: kgateway-system
          outCluster:
            - name: backend1
              host: host1.local
              port: 8080
            - name: backend2
              host: host2.local
              port: 8080
          backendPolicy:
            tls:
              insecureSkipVerify: true
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.targetRefs[0].name
          value: multi-backend1-backend
      - equal:
          path: spec.targetRefs[1].name
          value: multi-backend2-backend
