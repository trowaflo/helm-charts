suite: test kgateway-routing chart - route enablement
release:
  name: kgateway-routing-test
  namespace: kgateway-test
tests:
  # Test HTTPRoutes with default values (both routes enabled)
  - it: should render both HTTPRoutes when enabled
    template: templates/httproute.yaml
    values:
      - values/default.yaml
    asserts:
      - hasDocuments:
          count: 2  # 2 HTTPRoutes
      - isKind:
          of: HTTPRoute
        documentIndex: 0
      - equal:
          path: metadata.name
          value: argocd
        documentIndex: 0
      - isKind:
          of: HTTPRoute
        documentIndex: 1
      - equal:
          path: metadata.name
          value: homeassistant
        documentIndex: 1

  # Test Backend with default values
  - it: should render Backend when enabled
    template: templates/backend.yaml
    values:
      - values/default.yaml
    asserts:
      - hasDocuments:
          count: 1  # 1 Backend
      - isKind:
          of: Backend
        documentIndex: 0
      - equal:
          path: metadata.name
          value: homeassistant-homeassistant-backend
        documentIndex: 0

  # Test with only in-cluster route enabled
  - it: should only render in-cluster HTTPRoute when out-cluster disabled
    template: templates/httproute.yaml
    values:
      - values/only-incluster.yaml
    asserts:
      - hasDocuments:
          count: 1  # 1 HTTPRoute only
      - isKind:
          of: HTTPRoute
        documentIndex: 0
      - equal:
          path: metadata.name
          value: argocd
        documentIndex: 0

  # Test no backend when disabled
  - it: should not render Backend when disabled
    template: templates/backend.yaml
    values:
      - values/only-incluster.yaml
    asserts:
      - hasDocuments:
          count: 0

  # Test with only out-cluster route enabled
  - it: should only render out-cluster HTTPRoute when in-cluster disabled
    template: templates/httproute.yaml
    values:
      - values/only-outcluster.yaml
    asserts:
      - hasDocuments:
          count: 1  # 1 HTTPRoute
      - isKind:
          of: HTTPRoute
        documentIndex: 0
      - equal:
          path: metadata.name
          value: homeassistant
        documentIndex: 0

  # Test Backend rendering for out-cluster
  - it: should render Backend for out-cluster route
    template: templates/backend.yaml
    values:
      - values/only-outcluster.yaml
    asserts:
      - hasDocuments:
          count: 1  # 1 Backend
      - isKind:
          of: Backend
        documentIndex: 0
      - equal:
          path: metadata.name
          value: homeassistant-homeassistant-backend
        documentIndex: 0

  # Test with no routes enabled
  - it: should not render any HTTPRoutes when all disabled
    template: templates/httproute.yaml
    set:
      routes: {}
    asserts:
      - hasDocuments:
          count: 0

  # Test with no backends enabled (all routes disabled = no backends)
  - it: should not render any Backends when all routes disabled
    template: templates/backend.yaml
    set:
      routes: {}
    asserts:
      - hasDocuments:
          count: 0
