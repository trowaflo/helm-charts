name: Cleanup PR Charts

on:
  pull_request:
    types: [closed]
    paths:
      - "charts/**"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout pr-charts branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: pr-charts
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 #v4.3.1

      - name: Remove PR charts
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          
          # Remove chart packages with this PR number
          rm -f *-pr${PR_NUM}.tgz || true
          
          # Regenerate index without the removed charts
          helm repo index . --url https://raw.githubusercontent.com/${{ github.repository }}/pr-charts

      - name: Commit and push changes
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          
          git add -A
          git commit -m "Remove PR #${PR_NUM} charts after merge/close" || echo "No charts to remove"
          git push origin pr-charts || echo "Nothing to push"

      - name: Comment on PR
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ§¹ PR Charts Cleaned Up
            
            The test charts for this PR have been removed from the \`pr-charts\` branch now that the PR is merged.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
