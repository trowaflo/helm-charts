name: Helm Chart Version Bump (PR)

on:
  pull_request:
    paths:
      - "charts/**"

jobs:
  bump-version:
    if: github.actor != 'renovate[bot]'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 #v4.3.1
        with:
          fetch-depth: 0
          # récupère toutes les branches pour que git log fonctionne correctement
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 #v6.0.0
        with:
          node-version: 20

      - name: Install tools
        run: npm install -g semver

      - name: Detect changed charts
        id: detect_charts
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          git fetch origin $BASE_BRANCH

          charts_to_bump=()
          for file in $(git diff --name-only origin/$BASE_BRANCH..HEAD | grep '^charts/' || true); do
            chart_dir=$(dirname "$file")
            while [ ! -f "$chart_dir/Chart.yaml" ] && [ "$chart_dir" != "." ]; do
              chart_dir=$(dirname "$chart_dir")
            done
            chart="$chart_dir/Chart.yaml"
            if [ -f "$chart" ] && [[ ! " ${charts_to_bump[@]} " =~ " ${chart} " ]]; then
              charts_to_bump+=("$chart")
            fi
          done

          echo "charts_to_bump=${charts_to_bump[*]}" >> $GITHUB_OUTPUT
          echo "Charts to bump: ${charts_to_bump[*]}"

      # Step 2 – Bump chart versions + commit
      - id: bump
        name: Bump chart versions
        if: steps.detect_charts.outputs.charts_to_bump != ''
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          git fetch origin $BASE_BRANCH

          bumped_any=false

          for chart in ${{ steps.detect_charts.outputs.charts_to_bump }}; do
            chart_dir=$(dirname "$chart")

            BASE_VERSION=$(git show origin/$BASE_BRANCH:$chart | grep '^version:' | awk '{print $2}')
            CURRENT_VERSION=$(grep '^version:' "$chart" | awk '{print $2}')

            echo "Chart: $chart"
            echo "Base version ($BASE_BRANCH): $BASE_VERSION"
            echo "Current version (PR HEAD): $CURRENT_VERSION"

            if [ "$BASE_VERSION" != "$CURRENT_VERSION" ]; then
              echo "Version already bumped for $chart, skipping."
              continue
            fi

            # Commits affectant uniquement ce chart
            COMMITS=$(git log --pretty=%s --no-merges origin/$BASE_BRANCH..HEAD -- "$chart_dir")
            echo "Commits affecting $chart:"
            echo "$COMMITS"

            # Déterminer bump pour ce chart
            bump="patch"
            if echo "$COMMITS" | grep -q "BREAKING CHANGE"; then
              bump="major"
            elif echo "$COMMITS" | grep -Eq "^[a-z]+(\([a-z0-9_-]+\))?!:"; then
              bump="major"
            elif echo "$COMMITS" | grep -q "^feat"; then
              bump="minor"
            elif echo "$COMMITS" | grep -q "^fix"; then
              bump="patch"
            else
              bump="none"
            fi

            echo "Bump for $chart: $bump"

            if [ "$bump" != "none" ]; then
              new=$(npx semver $CURRENT_VERSION -i $bump)
              sed -i "s/^version:.*/version: $new/" "$chart"
              echo "Updated $chart from $CURRENT_VERSION to $new"
              bumped_any=true
            fi
          done

          if [ "$bumped_any" = true ]; then
            echo "bump=changed" >> $GITHUB_OUTPUT
          else
            echo "bump=none" >> $GITHUB_OUTPUT
          fi

      - id: commit
        name: Commit bump
        if: steps.bump.outputs.bump != 'none'
        run: |
          set -x
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add charts/**/Chart.yaml
          git commit -m "ci: bump chart versions [skip ci]"
          git push
